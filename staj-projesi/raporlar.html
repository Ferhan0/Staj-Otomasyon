<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raporlar - Adıyaman Üniversitesi</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { 
            background-color: #f8fafc; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .report-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 25px rgba(0,0,0,0.08);
            margin-bottom: 20px;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }
        .report-card:hover {
            box-shadow: 0 6px 30px rgba(0,0,0,0.12);
            transform: translateY(-2px);
        }
        .report-card.chart-card {
            border-left-color: #3b82f6;
        }
        .report-card.stats-card {
            border-left-color: #10b981;
        }
        .report-card.export-card {
            border-left-color: #f59e0b;
        }
        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }
        .stat-box {
            text-align: center;
            padding: 20px;
            border-radius: 10px;
            color: white;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .stat-box:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }
        .export-btn {
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            min-width: 150px;
        }
        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark" style="background: linear-gradient(135deg, #1e40af, #3b82f6);">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="dashboard.html">
                <i class="fas fa-graduation-cap me-2"></i>Adıyaman Üniversitesi
            </a>
            <div class="navbar-nav ms-auto">
                <a class="btn btn-outline-light" href="dashboard.html">
                    <i class="fas fa-arrow-left me-2"></i>Ana Panel
                </a>
            </div>
        </div>
    </nav>

    <div class="container my-4">
        <div class="text-center mb-4">
            <h2><i class="fas fa-chart-bar me-2"></i>Staj Raporları ve İstatistikler</h2>
            <p class="text-muted">Sistemdeki veriler üzerinden detaylı analiz ve raporlar</p>
        </div>

        <!-- Genel İstatistikler -->
        <div class="report-card stats-card">
            <div class="card-body">
                <h4 class="mb-4"><i class="fas fa-info-circle me-2"></i>Genel Özet</h4>
                <div class="row" id="genelStats">
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="stat-box" style="background: linear-gradient(135deg, #1e40af, #3b82f6);">
                            <h3 id="totalApplications"><span class="loading-spinner"></span></h3>
                            <p>Toplam Staj Başvurusu</p>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="stat-box" style="background: linear-gradient(135deg, #10b981, #059669);">
                            <h3 id="approvedApplications"><span class="loading-spinner"></span></h3>
                            <p>Onaylanan Başvuru</p>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="stat-box" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                            <h3 id="pendingApplications"><span class="loading-spinner"></span></h3>
                            <p>Bekleyen Başvuru</p>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="stat-box" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
                            <h3 id="rejectedApplications"><span class="loading-spinner"></span></h3>
                            <p>Reddedilen Başvuru</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Grafik ve Analizler -->
        <div class="row">
            <div class="col-md-6">
                <div class="report-card chart-card">
                    <div class="card-body">
                        <h5><i class="fas fa-pie-chart me-2"></i>Başvuru Durum Dağılımı</h5>
                        <div class="chart-container">
                            <canvas id="statusChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="report-card chart-card">
                    <div class="card-body">
                        <h5><i class="fas fa-university me-2"></i>Bölüm Dağılımı</h5>
                        <div class="chart-container">
                            <canvas id="departmentChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Firma Analizi -->
        <div class="row">
            <div class="col-md-6">
                <div class="report-card chart-card">
                    <div class="card-body">
                        <h5><i class="fas fa-building me-2"></i>Sektör Dağılımı</h5>
                        <div class="chart-container">
                            <canvas id="sectorChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="report-card chart-card">
                    <div class="card-body">
                        <h5><i class="fas fa-calendar me-2"></i>Aylık Başvuru Trendi</h5>
                        <div class="chart-container">
                            <canvas id="monthlyTrendChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Export Butonları -->
        <div class="report-card export-card">
            <div class="card-body text-center">
                <h5 class="mb-4"><i class="fas fa-download me-2"></i>Rapor Dışa Aktarma</h5>
                <div class="d-flex justify-content-center gap-3 flex-wrap">
                    <button class="btn btn-success export-btn" onclick="exportToExcel()">
                        <i class="fas fa-file-excel me-2"></i>Excel'e Aktar (.xlsx)
                    </button>
                    <button class="btn btn-primary export-btn" onclick="exportToCSV()">
                        <i class="fas fa-file-csv me-2"></i>CSV İndir
                    </button>
                    <button class="btn btn-info export-btn" onclick="printReport()">
                        <i class="fas fa-print me-2"></i>Yazdır
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        let stajlar = [];
        let firmalar = [];

        document.addEventListener('DOMContentLoaded', function() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser) {
                alert('Lütfen önce giriş yapınız!');
                window.location.href = 'index.html';
                return;
            }
            
            loadReports();
        });

        async function loadReports() {
            stajlar = JSON.parse(localStorage.getItem('stajBasvurulari')) || [];
            firmalar = JSON.parse(localStorage.getItem('firmalar')) || [];
            
            // Simulate loading with delays
            await updateStatistics();
            await new Promise(resolve => setTimeout(resolve, 500));
            createStatusChart();
            await new Promise(resolve => setTimeout(resolve, 300));
            createDepartmentChart();
            await new Promise(resolve => setTimeout(resolve, 300));
            createSectorChart();
            await new Promise(resolve => setTimeout(resolve, 300));
            createMonthlyTrendChart();
        }

        async function updateStatistics() {
            const stats = {
                total: stajlar.length,
                approved: stajlar.filter(s => s.durum === 'onaylandi').length,
                pending: stajlar.filter(s => s.durum === 'beklemede').length,
                rejected: stajlar.filter(s => s.durum === 'reddedildi').length
            };
            
            animateNumber('totalApplications', stats.total);
            animateNumber('approvedApplications', stats.approved);
            animateNumber('pendingApplications', stats.pending);
            animateNumber('rejectedApplications', stats.rejected);
        }

        function animateNumber(elementId, targetNumber) {
            const element = document.getElementById(elementId);
            element.innerHTML = ''; // Remove spinner
            let currentNumber = 0;
            const increment = Math.max(1, Math.floor(targetNumber / 30));
            
            const timer = setInterval(() => {
                currentNumber += increment;
                if (currentNumber >= targetNumber) {
                    currentNumber = targetNumber;
                    clearInterval(timer);
                }
                element.textContent = currentNumber;
            }, 50);
        }

        function createStatusChart() {
            const stats = {
                onaylandi: stajlar.filter(s => s.durum === 'onaylandi').length,
                beklemede: stajlar.filter(s => s.durum === 'beklemede').length,
                reddedildi: stajlar.filter(s => s.durum === 'reddedildi').length
            };

            const ctx = document.getElementById('statusChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Onaylandı', 'Beklemede', 'Reddedildi'],
                    datasets: [{
                        data: [stats.onaylandi, stats.beklemede, stats.reddedildi],
                        backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((context.parsed * 100) / total).toFixed(1) : 0;
                                    return `${context.label}: ${context.parsed} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function createDepartmentChart() {
            const departments = {};
            stajlar.forEach(staj => {
                if (staj.bolum) {
                    departments[staj.bolum] = (departments[staj.bolum] || 0) + 1;
                }
            });
            
            const sortedDepts = Object.entries(departments)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 8);
            
            const ctx = document.getElementById('departmentChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedDepts.map(([dept]) => dept.length > 20 ? dept.substring(0, 20) + '...' : dept),
                    datasets: [{
                        label: 'Başvuru Sayısı',
                        data: sortedDepts.map(([, count]) => count),
                        backgroundColor: [
                            '#3b82f6', '#10b981', '#f59e0b', '#ef4444',
                            '#8b5cf6', '#06b6d4', '#84cc16', '#f97316'
                        ],
                        borderRadius: 5,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        function createSectorChart() {
            const sectors = {};
            firmalar.forEach(firma => {
                if (firma.sektor) {
                    sectors[firma.sektor] = (sectors[firma.sektor] || 0) + 1;
                }
            });

            const ctx = document.getElementById('sectorChart').getContext('2d');
            new Chart(ctx, {
                type: 'polarArea',
                data: {
                    labels: Object.keys(sectors),
                    datasets: [{
                        data: Object.values(sectors),
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(245, 158, 11, 0.8)',
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(139, 92, 246, 0.8)',
                            'rgba(6, 182, 212, 0.8)'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        }
                    },
                    scales: {
                        r: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function createMonthlyTrendChart() {
            const monthlyData = {};
            
            // Initialize last 6 months
            const now = new Date();
            for (let i = 5; i >= 0; i--) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                const label = date.toLocaleDateString('tr-TR', { year: 'numeric', month: 'short' });
                monthlyData[key] = { label, count: 0 };
            }

            // Count applications by month
            stajlar.forEach(staj => {
                if (staj.basvuruTarihi) {
                    const [day, month, year] = staj.basvuruTarihi.split('.');
                    const key = `${year}-${month.padStart(2, '0')}`;
                    if (monthlyData[key]) {
                        monthlyData[key].count++;
                    }
                }
            });

            const ctx = document.getElementById('monthlyTrendChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Object.values(monthlyData).map(item => item.label),
                    datasets: [{
                        label: 'Başvuru Sayısı',
                        data: Object.values(monthlyData).map(item => item.count),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#3b82f6',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // Excel Export Function - WORKING
        function exportToExcel() {
            try {
                const workbook = XLSX.utils.book_new();
                
                // Staj Applications Sheet
                const stajData = stajlar.map(staj => ({
                    'Başvuru No': staj.id,
                    'Ad Soyad': staj.adSoyad,
                    'Öğrenci No': staj.ogrenciNo,
                    'Fakülte': staj.fakulte || '',
                    'Bölüm': staj.bolum,
                    'Sınıf': staj.sinif || '',
                    'Telefon': staj.telefon,
                    'E-posta': staj.email,
                    'Staj Türü': staj.stajTuru,
                    'Başlangıç Tarihi': staj.baslangicTarihi,
                    'Bitiş Tarihi': staj.bitisTarihi,
                    'Firma Adı': staj.firmaAdi,
                    'Firma Sektörü': staj.firmaSektoru,
                    'Yetkili Kişi': staj.yetkiliKisi || '',
                    'Başvuru Tarihi': staj.basvuruTarihi,
                    'Durum': staj.durum
                }));
                
                const stajSheet = XLSX.utils.json_to_sheet(stajData);
                XLSX.utils.book_append_sheet(workbook, stajSheet, 'Staj Başvuruları');
                
                // Companies Sheet
                const firmaData = firmalar.map(firma => ({
                    'ID': firma.id,
                    'Firma Adı': firma.firmaAdi,
                    'Sektör': firma.sektor,
                    'Adres': firma.adres,
                    'Telefon': firma.telefon,
                    'E-posta': firma.email,
                    'Web Sitesi': firma.webSitesi || '',
                    'Yetkili Adı': firma.yetkiliAdi,
                    'Yetkili Telefon': firma.yetkiliTelefon,
                    'Yetkili E-posta': firma.yetkiliEmail,
                    'Stajyer Kapasitesi': firma.stajyerSayisi,
                    'Kayıt Tarihi': firma.kayitTarihi
                }));
                
                const firmaSheet = XLSX.utils.json_to_sheet(firmaData);
                XLSX.utils.book_append_sheet(workbook, firmaSheet, 'Firmalar');
                
                // Statistics Sheet
                const stats = {
                    'Toplam Başvuru': stajlar.length,
                    'Onaylanan': stajlar.filter(s => s.durum === 'onaylandi').length,
                    'Bekleyen': stajlar.filter(s => s.durum === 'beklemede').length,
                    'Reddedilen': stajlar.filter(s => s.durum === 'reddedildi').length,
                    'Toplam Firma': firmalar.length,
                    'Rapor Tarihi': new Date().toLocaleDateString('tr-TR')
                };
                
                const statsData = Object.entries(stats).map(([key, value]) => ({ 'İstatistik': key, 'Değer': value }));
                const statsSheet = XLSX.utils.json_to_sheet(statsData);
                XLSX.utils.book_append_sheet(workbook, statsSheet, 'İstatistikler');
                
                // Generate filename with current date
                const fileName = `staj_sistemi_raporu_${new Date().toLocaleDateString('tr-TR').replace(/\./g, '_')}.xlsx`;
                
                // Write and download file
                XLSX.writeFile(workbook, fileName);
                
                showToast('Excel raporu başarıyla indirildi!', 'success');
                
            } catch (error) {
                console.error('Excel export error:', error);
                showToast('Excel dışa aktarma sırasında bir hata oluştu.', 'error');
            }
        }

        function exportToCSV() {
            let csv = 'Başvuru No,Ad Soyad,Öğrenci No,Bölüm,Staj Türü,Firma,Sektör,Başvuru Tarihi,Durum\n';
            
            stajlar.forEach(staj => {
                csv += `${staj.id},"${staj.adSoyad}","${staj.ogrenciNo}","${staj.bolum}","${staj.stajTuru}","${staj.firmaAdi}","${staj.firmaSektoru}","${staj.basvuruTarihi}","${staj.durum}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `staj_raporu_${new Date().toLocaleDateString('tr-TR').replace(/\./g, '_')}.csv`;
            link.click();
            
            showToast('CSV dosyası başarıyla indirildi!', 'success');
        }

        function printReport() {
            window.print();
        }

        function showToast(message, type = 'info') {
            const toastId = 'toast_' + Date.now();
            const toastHtml = `
                <div id="${toastId}" class="alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show" 
                     style="position: fixed; top: 20px; right: 20px; z-index: 1070; min-width: 300px;">
                    <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'exclamation-triangle' : 'info'} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" onclick="document.getElementById('${toastId}').remove()"></button>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', toastHtml);
            
            setTimeout(() => {
                const toast = document.getElementById(toastId);
                if (toast) toast.remove();
            }, 3000);
        }
    </script>
</body>
</html>